# Recommendation Service Wiki

## Введение

Этот сервис предназначен для предоставления персонализированных рекомендаций клиентам SkyPro School. Он использует динамические правила, основанные на данных о транзакциях, для генерации соответствующих предложений.

## Архитектура

Сервис построен на основе:

•   **Spring Boot:** Для построения RESTful API.

•   **Spring Data JPA:** Для работы с базой данных (PostgreSQL).

•   **Lombok:** Для уменьшения шаблонного кода.

•   **Swagger:** Для автоматической генерации документации API.

## Сущности

•   **DynamicRule:** Представляет собой правило, используемое для генерации рекомендаций. Содержит имя продукта, текст продукта и набор запросов.

•   **DynamicRuleQuery:** Содержит конкретный запрос для правила (например, "транзакция > 1000") и флаг для отрицания.

•   **Recommendation:** DTO, представляющий рекомендацию для пользователя (ID, название, текст).

•   **RecommendationResponse:** Объект ответа, содержащий список рекомендаций для конкретного пользователя.

## Эндпоинты API

•   **Health Check:**
•   `/health`: Возвращает статус приложения и его версию.

•   **Recommendation:**
•   `GET /recommendation/{user_id}`: Получает список рекомендаций для пользователя с заданным ID.

•   **Dynamic Rule:**
•   `POST /rule`: Создает новое динамическое правило.
•   `DELETE /rule/{id}`: Удаляет динамическое правило по его ID.
•   `GET /rule`: Получает список всех динамических правил.

## User Story

**▎User Story 1:** Рекомендации для пользователей

ID: US-001  
Как пользователь,  
Я хочу получать рекомендации по банковским продуктам,  
Чтобы я мог выбирать наиболее подходящие для меня продукты на основе моих финансовых данных и поведения.

Критерии приемки:

1. Пользователь может получить список рекомендованных продуктов, отправив свой ID.
2. Рекомендации формируются на основе динамических правил, которые проверяют соответствие пользователя критериям.
3. Если пользователь соответствует всем правилам, продукт добавляется в список рекомендаций с его названием и описанием.

**▎User Story 2:** Управление динамическими правилами

ID: US-002  
Как менеджер,  
Я хочу иметь возможность добавлять, удалять и получать список динамических правил,  
Чтобы я мог управлять правилами, по которым формируются рекомендации пользователям.

Критерии приемки:

1. Менеджер может добавить новое правило через API.
2. Менеджер может удалить существующее правило через API.
3. Менеджер может получить список всех правил через API.


**▎User Story 3:** Кеширование запросов

ID: US-003  
Как разработчик,  
Я хочу кешировать результаты SQL запросов к базе данных,  
Чтобы ускорить время ответа на повторные запросы от пользователей.

Критерии приемки:

1. Все запросы к базе данных кешируются.
2. Повторные запросы с одним и тем же ID пользователя обрабатываются быстрее, чем первый запрос.
3. Кеширование реализовано с использованием библиотеки Caffeine.


**▎User Story 4:** Рекомендации через Телеграм-бота

ID: US-004  
Как пользователь,  
Я хочу получать рекомендации по банковским продуктам через Телеграм-бота,  
Чтобы я мог быстро и удобно получать информацию о новых продуктах.

Критерии приемки:

1. При первом обращении бот приветствует пользователя и выводит справку.
2. Пользователь может ввести команду `/recommend username`, чтобы получить рекомендации.
3. Бот возвращает сообщение: "Здравствуйте <Имя и фамилия пользователя>. Новые продукты для вас: <список продуктов>."
4. Если пользователь не найден или найдено несколько пользователей, бот выдает сообщение «Пользователь не найден».


**▎User Story 5:** Статистика срабатывания правил рекомендаций

ID: US-005  
Как менеджер,  
Я хочу вести статистику срабатывания динамических правил рекомендаций,  
Чтобы я мог анализировать эффективность правил и вносить изменения при необходимости.

Критерии приемки:

1. При выполнении динамического правила для пользователя увеличивается счетчик срабатываний на единицу.
2. При удалении динамического правила его счетчик срабатываний также удаляется.
3. Если правило еще не имело срабатываний, оно должно оставаться в списке со значением 0.
4. Менеджер может получить статистику срабатываний правил через запрос /rule/stats.


**▎User Story 6:** Сброс кеша рекомендаций

ID: US-006  
Как разработчик,  
Я хочу реализовать метод для сброса кеша,  
Чтобы обновить результаты рекомендаций и обеспечить актуальность данных.

Критерии приемки:

1. При POST-запросе на /management/clear-caches очищаются все закешированные результаты.
2. Запрос не принимает тело и возвращает успешный статус выполнения.


**▎User Story 7:** Информация о сервисе

ID: US-007  
Как менеджер,  
Я хочу получать информацию о сервисе,  
Чтобы иметь возможность управлять и контролировать его состояние.

Критерии приемки:

1. Сервис поддерживает запрос `/management/info`, который возвращает данные в формате:
```
   {
   "name": "<название сервиса>",
   "version": "<версия сервиса>"
   }
   ```

## Нефункциональные требования к проекту

**▎НФТ-001: Производительность**

• Время отклика: Система должна обрабатывать запросы пользователей с временем отклика не более 200 мс для получения рекомендаций.

• Пропускная способность: Система должна поддерживать не менее 1000 одновременных пользователей без ухудшения производительности.

**▎НФТ-002: Надежность**

• Доступность: Система должна обеспечивать 99.9% доступности в течение месяца.

• Восстановление после сбоев: В случае сбоя система должна автоматически восстанавливаться в течение 5 минут.

**▎НФТ-003: Масштабируемость**

• Горизонтальная масштабируемость: Система должна поддерживать добавление новых серверов для обработки увеличивающегося объема трафика.

• Вертикальная масштабируемость: Возможность увеличения ресурсов (CPU, RAM) на существующих серверах без значительных изменений в архитектуре.

**▎НФТ-004: Удобство использования**

• Документация: Должна быть доступна полная документация по использованию системы для конечных пользователей и разработчиков.

**▎НФТ-005: Совместимость**

• Кросс-браузерная совместимость: Система должна корректно работать в основных браузерах (Chrome, Firefox, Safari, Edge).

• Интеграция с внешними системами: Возможность интеграции с другими сервисами и API без значительных усилий.

**▎НФТ-006: Поддерживаемость**

• Логирование и мониторинг: Система должна иметь механизмы логирования и мониторинга для отслеживания состояния и производительности.

• Обновляемость: Процесс обновления системы должен быть простым и не требовать значительных затрат времени.

**▎НФТ-007: Экологичность**

• Энергоэффективность: Система должна использовать ресурсы эффективно, минимизируя потребление энергии.

## Обработка ошибок

Сервис обрабатывает следующие исключения:

•   `RulesNotFoundException`: Когда не найдено ни одного подходящего правила.

•   `RecommendationNotFoundException`: Когда не найдено ни одной рекомендации для пользователя.

•   `NoTransactionsFoundException`: Когда у пользователя нет транзакций.

•   `NullArgumentException`: Когда передан null аргумент.

•   `UnknownQueryTypeException`: Когда тип запроса неизвестен.

•  `UnknownTransactionType`: Когда тип транзакции неизвестен.

•  `UnknownComparisonTypeException`: Когда тип сравнения неизвестен.

•   `RepositoryNotInitializedException`: Когда произошла ошибка при инициализации репозитория.

•   `Exception`: Для всех непредвиденных ошибок.

Подробности об обработке ошибок можно посмотреть в классе `GlobalExceptionHandler`.

## Конфигурация

Конфигурация приложения (например, подключение к БД) производится через `application.properties`.
Основные свойства:
```
properties
spring.datasource.url=jdbc:postgresql://localhost:5432/yourdb
spring.datasource.username=youruser
spring.datasource.password=yourpassword
spring.jpa.hibernate.ddl-auto=update
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
spring.application.name=fintech-recommendation-service
build.version=1.0
```

## Развертывание

Сервис можно развернуть с помощью Docker или в любом другом окружении Java. Рекомендуется использовать Docker для простоты.
Деплой осуществляется с помощью Github Action в Kubernetes.

## Контакты

По всем вопросам обращайтесь: [Ира Богомолова](воткнуть ссыль)

